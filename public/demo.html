<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ask Nora for a Quote</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;        /* charcoal */
      --muted: #6b7280;       /* gray-500 */
      --ring: #111827;
      --pill: #111827;
      --pillText: #fff;
      --border: #e5e7eb;
      --card: #ffffff;
      --shadow: 0 10px 25px rgba(17, 24, 39, .08);
      --radius: 14px;
    }
    html, body { height: 100%; background: var(--bg); }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      color: var(--text); -webkit-font-smoothing: antialiased; line-height: 1.45;
      display: flex; align-items: flex-start; justify-content: center;
    }
    .wrap { width: 100%; max-width: 920px; padding: 32px 16px 64px; }
    h1 { font-size: 32px; margin: 8px 0 8px; text-align: center; }
    .sub { text-align: center; color: var(--muted); margin-bottom: 24px; }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 22px 22px 16px;
    }
    .row { margin-bottom: 14px; }
    .lbl { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
    .group { display: flex; flex-wrap: wrap; gap: 8px; }
    .pill {
      appearance: none; border: 1px solid var(--border); background: #fff; color: var(--text);
      border-radius: 999px; padding: 8px 14px; cursor: pointer; font: inherit;
    }
    .pill[aria-pressed="true"] { background: var(--pill); color: var(--pillText); border-color: var(--pill); }
    .text, .date {
      width: 100%; border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; font: inherit;
    }
    .text:focus, .date:focus { outline: none; border-color: var(--ring); box-shadow: 0 0 0 3px rgba(17,24,39,.1); }
    .help { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .actions { display: flex; gap: 10px; margin-top: 6px; }
    .btn {
      appearance: none; border: 1px solid var(--ring); background: var(--ring); color: #fff;
      border-radius: 10px; padding: 12px 16px; font: 600 14px/1 ui-sans-serif, system-ui;
      cursor: pointer;
    }
    .btn[disabled] { opacity: .55; cursor: not-allowed; }
    .outline { background: #fff; color: var(--ring); }
    .result { margin-top: 18px; border: 1px solid var(--border); border-radius: 10px; padding: 12px 12px; }
    .result .line { background: #f3f4f6; border-radius: 8px; padding: 10px 12px; margin: 8px 0; }
    .footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 16px; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Ask Nora for a Quote</h1>
    <p class="sub">Our AI assistant can generate instant videography quotes for your clients.</p>

    <section class="card" role="form" aria-labelledby="form-title">
      <h2 id="form-title" class="lbl" style="margin-bottom:12px;color:var(--text)">
        Quick Quote • Tell us a few details
      </h2>

      <!-- Step 1: Event -->
      <div class="row">
        <div class="lbl">What type of event is this?</div>
        <div class="group" id="eventGroup" role="group" aria-label="Event type">
          <button class="pill" data-value="Corporate">Corporate</button>
          <button class="pill" data-value="Wedding">Wedding</button>
          <button class="pill" data-value="Mitzvah">Mitzvah</button>
          <button class="pill" data-value="Other">Other</button>
        </div>
      </div>

      <!-- Step 2: Hours -->
      <div class="row" id="hoursRow" hidden>
        <div class="lbl">About how many hours of coverage?</div>
        <div class="group" id="hoursGroup" role="group" aria-label="Hours">
          <button class="pill" data-value="4">4</button>
          <button class="pill" data-value="6">6</button>
          <button class="pill" data-value="8">8</button>
          <button class="pill" data-value="10">10</button>
          <button class="pill" data-value="12">12</button>
        </div>
        <div class="help">We’ll enforce your 4-hour minimum automatically.</div>
      </div>

      <!-- Step 3: Crew -->
      <div class="row" id="crewRow" hidden>
        <div class="lbl">Crew</div>
        <div class="group" id="crewGroup" role="group" aria-label="Crew">
          <button class="pill" data-lead="1" data-second="0">1 Lead</button>
          <button class="pill" data-lead="1" data-second="1">1 Lead + 1 Second</button>
          <button class="pill" data-lead="2" data-second="1">2 Leads + 1 Second</button>
        </div>
      </div>

      <!-- Step 4: Location / Travel -->
      <div class="row" id="locRow" hidden>
        <div class="lbl">Travel</div>
        <div class="group" id="locGroup" role="group" aria-label="Travel range">
          <button class="pill" data-value="local">Local (within ~1.5 hr)</button>
          <button class="pill" data-value="far">Far (over ~1.5 hr)</button>
        </div>
        <div class="help">Local adds your standard $100 travel; Far uses your $400 travel rule.</div>
      </div>

      <!-- Step 5: Add-ons -->
      <div class="row" id="addonsRow" hidden>
        <div class="lbl">Optional add-ons</div>
        <div class="group" id="addonsGroup" role="group" aria-label="Add-ons">
          <button class="pill" data-key="secondShooter">Second Videographer</button>
          <button class="pill" data-key="drone">Drone</button>
          <button class="pill" data-key="livestream">Livestream</button>
          <button class="pill" data-key="rush48">48-hr Rush Edit</button>
          <button class="pill" data-key="rush24">24-hr Rush Edit</button>
        </div>
      </div>

      <!-- Step 6: Date -->
      <div class="row" id="dateRow" hidden>
        <div class="lbl">Event date (format: dd/MM/yyyy)</div>
        <input id="dateInput" class="text" placeholder="dd/MM/yyyy" inputmode="numeric" autocomplete="off" />
      </div>

      <div class="actions">
        <button id="quoteBtn" class="btn" disabled>Get Quote</button>
        <button id="resetBtn" class="btn outline" type="button">Reset</button>
      </div>

      <div id="result" class="result" hidden></div>
    </section>

    <p class="footer">© Cinematic Videographers · Nora Assistant</p>
  </main>

  <script>
    // ------- State -------
    const state = {
      eventType: null,
      hours: null,
      crew: { lead: null, second: null },
      locationType: null,     // 'local' | 'far'
      addons: {               // booleans; UI toggles these
        secondShooter: false,
        drone: false,
        livestream: false,
        rush48: false,
        rush24: false
      },
      eventDate: ''
    };

    // ------- helpers -------
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const $  = (s, r = document) => r.querySelector(s);
    const enable = el => el.removeAttribute('disabled');
    const disable = el => el.setAttribute('disabled', 'true');
    const show = el => el.hidden = false;
    const hide = el => el.hidden = true;

    function pressToggle(btn, pressed) {
      btn.setAttribute('aria-pressed', String(pressed));
    }
    function exclusive(group, btn) {
      $$(".pill", group).forEach(b => pressToggle(b, false));
      pressToggle(btn, true);
    }

    // dd/MM/yyyy validation
    function isValidDMY(str) {
      const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(String(str).trim());
      if (!m) return false;
      const dd = +m[1], mm = +m[2], yy = +m[3];
      const d = new Date(yy, mm - 1, dd);
      return d.getFullYear() === yy && (d.getMonth()+1) === mm && d.getDate() === dd;
    }

    function canQuote() {
      return !!(state.eventType
        && state.hours
        && Number.isInteger(state.crew.lead)
        && Number.isInteger(state.crew.second)
        && state.locationType
        && isValidDMY(state.eventDate));
    }

    function updateQuoteButton() {
      if (canQuote()) enable($('#quoteBtn'));
      else disable($('#quoteBtn'));
    }

    // ------- wiring -------
    // Step 1
    $("#eventGroup").addEventListener("click", (e) => {
      const b = e.target.closest(".pill");
      if (!b) return;
      exclusive($("#eventGroup"), b);
      state.eventType = b.dataset.value;
      show($("#hoursRow"));
      // suggest presets for hours & crew when event chosen (but still require user click)
      if (state.eventType === "Wedding") {
        // suggest 10h, 1 lead + 1 second
      } else if (state.eventType === "Mitzvah") {
        // suggest 8h, 1 lead + 1 second
      } else {
        // corporate / other typical 4h
      }
      updateQuoteButton();
    });

    // Step 2
    $("#hoursGroup").addEventListener("click", (e) => {
      const b = e.target.closest(".pill");
      if (!b) return;
      exclusive($("#hoursGroup"), b);
      state.hours = parseInt(b.dataset.value, 10) || null;
      show($("#crewRow"));
      updateQuoteButton();
    });

    // Step 3
    $("#crewGroup").addEventListener("click", (e) => {
      const b = e.target.closest(".pill");
      if (!b) return;
      exclusive($("#crewGroup"), b);
      state.crew.lead   = parseInt(b.dataset.lead, 10);
      state.crew.second = parseInt(b.dataset.second, 10);
      show($("#locRow"));
      updateQuoteButton();
    });

    // Step 4
    $("#locGroup").addEventListener("click", (e) => {
      const b = e.target.closest(".pill");
      if (!b) return;
      exclusive($("#locGroup"), b);
      state.locationType = b.dataset.value; // local | far
      show($("#addonsRow"));
      show($("#dateRow"));
      updateQuoteButton();
    });

    // Step 5 (toggles)
    $("#addonsGroup").addEventListener("click", (e) => {
      const b = e.target.closest(".pill");
      if (!b) return;
      const key = b.dataset.key;
      const now = b.getAttribute('aria-pressed') === 'true';
      pressToggle(b, !now);
      state.addons[key] = !now;
      updateQuoteButton();
    });

    // Step 6 (date)
    $("#dateInput").addEventListener("input", (e) => {
      state.eventDate = e.target.value.trim();
      updateQuoteButton();
    });

    // Reset
    $("#resetBtn").addEventListener("click", () => {
      // clear state
      state.eventType = null;
      state.hours = null;
      state.crew = { lead: null, second: null };
      state.locationType = null;
      state.addons = { secondShooter:false, drone:false, livestream:false, rush48:false, rush24:false };
      state.eventDate = '';
      // clear UI
      $$(".pill").forEach(b => pressToggle(b, false));
      $("#dateInput").value = '';
      // hide later rows
      show($("#hoursRow")); hide($("#crewRow")); hide($("#locRow")); hide($("#addonsRow")); hide($("#dateRow"));
      hide($("#hoursRow")); // start hidden again
      $('#result').hidden = true;
      updateQuoteButton();
    });

    // Quote
    $("#quoteBtn").addEventListener("click", async () => {
      if (!canQuote()) return;
      disable($("#quoteBtn"));
      const result = $("#result");
      result.hidden = false;
      result.innerHTML = `<div class="line">Great — calculating your quote…</div>`;

      try {
        const payload = {
          eventType: state.eventType,
          hours: state.hours,
          crew: state.crew,
          locationType: state.locationType,   // local | far
          addons: state.addons,
          eventDate: state.eventDate          // dd/MM/yyyy
        };

        const r = await fetch('/api/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json();

        if (!r.ok) throw new Error(data?.error || 'Failed to get quote');

        const lines = [
          `<div class="line"><strong>Total Quote:</strong> $${Number(data.total).toLocaleString()}</div>`
        ];
        if (Array.isArray(data.breakdown)) {
          data.breakdown.forEach(item => {
            lines.push(`<div class="line">${item.label}: $${Number(item.amount).toLocaleString()}</div>`);
          });
        }
        result.innerHTML = lines.join('');
      } catch (err) {
        result.innerHTML = `<div class="line">Error: ${err.message}</div>`;
      } finally {
        enable($("#quoteBtn"));
      }
    });
  </script>
</body>
</html>
